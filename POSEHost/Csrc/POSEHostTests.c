#include <stdio.h>
#include <stdlib.h>

#include "POSEManager.h"
#include "PythonWrapper.h"

int main(void) {
	// manager tests
	PyObject* pModule = initPyModule("manager");
	init(pModule);

	// EXPECTED DATA FOR TEST:
	private_key = 0xb0057716d5917badaf911b193b12b910811c1497b5bada8d7711f758981c3773
	att_hash = keccak(encode_abi(['string', 'bytes32', 'address', 'bytes'],
					['Furious-Attest',
					Web3.toBytes(hexstr='0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563'),
					Web3.toChecksumAddress("0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1"),
					Web3.toBytes(hexstr='0x00')]))
	registered operator: 0x90F8bf6A47 9f320ead07 4411a4B0e7 944Ea8c9C1

	EthAddr addr = {0x90, 0xf8, 0xbf, 0x6a, 0x47, 0x9f, 0x32, 0x0e, 0xad, 0x07,
					0x44, 0x11, 0xa4, 0xb0, 0xe7, 0x94, 0x4e, 0xa8, 0xc9, 0xc1};
	Hash hash = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
				0x00, 0x01};
	EnclavePK epk = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03};
	EnclaveSig esig = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
					0x00, 0x01, 0x02, 0x03, 0x04};
	EthAddr poolOps[POOL_SIZE] = {addr, addr, addr};
	int contractId = 1;

	// MAIN CONTRACT CALLS: all calls return nothing on success
	// may return operator already registered error:
	int result1 = registerEnclave(pModule, addr, epk, esig);
	printf("registerEnclave: %d", result1);
	// may return contract already exists error:
	int result2 = initContractCreation(pModule, addr, hash, contractId);
	printf("initContractCreation: %d", result2);
	// requires encoded sig to function!
	int result3 = finalizeCreation(pModule, contractId, addr, poolOps, esig);
	printf("finalizeCreation: %d", result3);

	// GETTER CALLS: return values
	struct addrList result4 = getOperatorList(pModule);
	for(int i = 0; i < result4.len_list; i++) {
		printf("op %d: ", i+1);
		printBytesAsHex(ADDR_SIZE, result4.list[i]);
		printf("\n");
	}
	
	// ENCODED VERSION
	struct eventDataEncoded result6 = getEventTxsSinceEncoded(pModule, contractId, 0);
	for(int i = 0; i < result6.len_list; i++) {
		printf("event %d: encoded_data: ", i+1);
		printBytesAsHex(result6.len[i], *result6.bytesData[i]);
	}

	// END
	destroyPyModule(pModule);
	return EXIT_SUCCESS;
}
